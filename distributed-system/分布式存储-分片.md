# 数据分片

## 为什么需要数据分片

“分片”技术，突破单机存储和性能瓶颈，让分布式系统的计算和存储能力可以线性扩展。

第一条是垂直扩容，即 PC 机扛不住换小型机，小型机扛不住换大型机，大型机扛不住换超级计算机，通过不断提高机器的配置来应对数据的增长。但是，这条道路会受到材料的物理极限、制造的工艺水平和使用成本的限制，不是一条可持续的道路。

另一条是水平扩容，即通过将数据进行分片，分散到不同的 PC 机上，每一个 PC 节点负责一部分数据的存储和计算，来应对数据和成本的增长。这一条道路是由 Google 在 2000 年代的三篇论文 **GFS 、MapReduce 和 BigTable** 开启的，并且成为了解决数据激增问题的事实标准。

## 分片策略

数据进行分片的策略，主要有三种：水平分片、垂直分片和混合分片。

水平分片和垂直分片是通过数据切分的操作方向来区分的，而混合分片是它们的组合体。

### 水平分片

从流量角度来看，是负载均衡，从数据存储角度来看，是水平分片。

#### 数据划分

* 基于模运算
* 基于范围
  * 基于关键词划分
  * 基于关键词的 Hash 值划分

一个好的 Hash 算法可以处理数据倾斜并让它均匀分布。

基于关键词的 Hash 值划分，带来了数据分布和访问热度更均匀的优点，但同时，它也失去了基于关键词的顺序性，不能方便地通过关键词进行区间查询了。

#### 数据平衡

根据数据分片是否支持动态的分裂与合并，我们可以将水平分片的数据平衡方式分为：

* 静态分片：在系统设计之初，数据分片的数目和区间就预估好了，数据划分后不能再变化
* 动态分片：在运行时，根据分片的负载和容量做调整。

#### 分析

| 水平分片策略                | 优点                                         | 缺点                                                         | 应用场景               |
| --------------------------- | -------------------------------------------- | ------------------------------------------------------------ | ---------------------- |
| 模运算/静态平衡             | 规则简单                                     | 初次实施后，不能自动水平扩容。<br />如果人工扩容，数据迁移工作量大 | 传统关系型数据库       |
| 模运算/动态平衡             | 规则简单                                     | 增加节点后，数据迁移量大                                     | 很少被使用             |
| 基于关键词划分/静态平衡     | 对关键词区间查询效率高                       | 有限的水平扩容能力。<br />数据分布和访问容易出现热点。       | 很少被使用             |
| 基于关键词划分/动态平衡     | 对关键词区间查询效率高。<br />水平扩容能力好 | 数据分布和访问容易出现热点。                                 | TiDB，BigTable，H Base |
| 基于关键词Hash划分/静态平衡 | 数据分布和访问比较均匀。                     | 有限的水平扩容能力。<br />对关键词区间查询效率低             | Codis，Redis Cluster   |
| 基于关键词Hash划分/动态平衡 | 数据分布和访问比较均匀。<br />水平扩容能力好 | 对关键词区间查询效率低                                       | Cassandra              |

### 垂直分片

水平分片策略将整个数据集的条数作为划分的对象，每一个分片负责处理一定的数据条数。

而垂直分片策略则是将数据 Schema 的字段集个数作为划分的对象，每一个分片负责处理一个或几个字段的全部数据。

如果垂直分片策略的处理方式为一个字段一个分片，那么垂直分片策略就等价于列式存储了，所以列式存储是垂直分片策略的一种特殊情况，也是最常见的情况。

特点：

* **宽表存储，按列读取**：数据往往以宽表的形式存储，一个表上百列，但是一次分析往往只关心一列或者几列。
* **读多写少**：一次写入，多次读取，几乎不更新，会减少列式存储对写性能的影响。
* **数据量大**：大数据会存储全站的所有数据，包括日志和数据库内的数据，并且会持续增加。
* **查询无规律，不能索引覆盖**：在分析场景中，我们会通过各种维度和组合，来统计和分析数据，所以这些查询方式是无规律的，不可能全部通过索引来覆盖。

### 混合分片

水平分片策略和垂直分片策略的结合体，它对于整个数据集来说，一般是主键先利用基于关键词划分的水平分片策略，将数据集成不同的分片，然后对一个分片内的数据再进行垂直分片。

这样带来的好处是在一个水平分片内，依然按列式存储来存储数据，所以它有列式存储按列读取数据，高效和压缩比高的优点。在按行写入和读取多列的时候，都在一个数据分片上，大大地减少了网络 IO ，要知道在大规模的数据处理系统中，网络 IO 有可能是整个系统的瓶颈，同时，也能将一些分布式事务变成本地事务，提升系统的处理效率。

## 行列存储比较

| 维度     | 行式存储                                         | 列式存储                                                     |
| -------- | ------------------------------------------------ | ------------------------------------------------------------ |
| 数据存储 | 按行顺序存储                                     | 按列顺序存储                                                 |
| 按行填写 | 数据顺序存储，可以顺序读写，效率高               | 由于数据按列存储，一个行操作的读写，分布在多个存储位置不同的列上，导致读写放大，效率低 |
| 按列读取 | 会导致读放大，或者随机读取，效率低               | 按列读取，效率高                                             |
| 压缩效率 | 不同列的数据混合在一起，数据规律性差，压缩效率低 | 同一列的数据存储在一起，数据规律性强，压缩效率高             |
| 使用场景 | OLAP                                             | OLTP                                                         |

